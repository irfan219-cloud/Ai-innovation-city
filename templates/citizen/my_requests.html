<!-- Save this as: templates/citizen/my_requests.html -->
<!-- Enhanced My Requests with Comprehensive Statistics -->

{% extends "base.html" %}

{% block title %}📋 My Requests - Meri Dharani{% endblock %}

{% block extra_head %}
<style>
    .request-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .request-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    
    .status-submitted { border-left-color: #3B82F6; }
    .status-processing { border-left-color: #F59E0B; }
    .status-assigned { border-left-color: #8B5CF6; }
    .status-in-progress { border-left-color: #EF4444; }
    .status-completed { border-left-color: #10B981; }
    .status-rejected { border-left-color: #6B7280; }
    
    .filter-active {
        background: linear-gradient(135deg, #10B981, #059669) !important;
        color: white !important;
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }
    
    .floating-add-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 50;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .empty-state {
        background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%);
    }
    
    .timeline-item {
        position: relative;
        padding-left: 2rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0.5rem;
        width: 0.75rem;
        height: 0.75rem;
        background: #10B981;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 0 3px #10B981;
    }
    
    .timeline-item::after {
        content: '';
        position: absolute;
        left: 0.75rem;
        top: 1.25rem;
        width: 2px;
        height: calc(100% - 1rem);
        background: #E5E7EB;
    }
    
    .timeline-item:last-child::after {
        display: none;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transform: translateY(0);
        transition: all 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .progress-ring {
        transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
        stroke-dasharray: 251.2;
        stroke-dashoffset: 251.2;
        transition: stroke-dashoffset 1s ease-in-out;
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .impact-badge {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-submitted { background-color: #DBEAFE; color: #1D4ED8; }
    .badge-processing { background-color: #FEF3C7; color: #D97706; }
    .badge-assigned { background-color: #EDE9FE; color: #7C3AED; }
    .badge-in-progress { background-color: #FEE2E2; color: #DC2626; }
    .badge-completed { background-color: #D1FAE5; color: #059669; }
    .badge-rejected { background-color: #F3F4F6; color: #6B7280; }
    
    .search-box {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .metric-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
    
    <!-- Header Section with Enhanced Stats -->
    <div class="bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 text-white">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div class="mb-6 lg:mb-0">
                    <h1 class="text-3xl lg:text-4xl font-bold mb-2">📋 My Requests</h1>
                    <p class="text-emerald-100 text-lg">Track your environmental impact and cleanup requests</p>
                    <div class="flex items-center mt-2">
                        <span class="text-emerald-200 text-sm">Last updated: </span>
                        <span class="text-white font-semibold ml-1" id="lastUpdated">Just now</span>
                    </div>
                </div>
                
                <!-- Quick Stats Overview -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                    <div class="metric-card p-4 rounded-xl">
                        <div class="text-2xl font-bold text-emerald-600" id="totalRequests">{{ total_requests or 0 }}</div>
                        <div class="text-sm text-slate-600">Total Requests</div>
                    </div>
                    <div class="metric-card p-4 rounded-xl">
                        <div class="text-2xl font-bold text-amber-600" id="activeRequests">0</div>
                        <div class="text-sm text-slate-600">Active</div>
                    </div>
                    <div class="metric-card p-4 rounded-xl">
                        <div class="text-2xl font-bold text-green-600" id="completedRequests">0</div>
                        <div class="text-sm text-slate-600">Completed</div>
                    </div>
                    <div class="metric-card p-4 rounded-xl">
                        <div class="text-2xl font-bold text-purple-600" id="impactScore">0</div>
                        <div class="text-sm text-slate-600">Impact Score</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Comprehensive Statistics Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <!-- Environmental Impact Stats -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-6 flex items-center">
                    🌱 Environmental Impact
                    <div class="ml-auto">
                        <select id="impactTimeRange" class="text-sm border border-slate-300 rounded-lg px-3 py-1">
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                </h3>
                
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="text-center p-4 bg-green-50 rounded-xl">
                        <div class="text-2xl font-bold text-green-600" id="co2Saved">0 kg</div>
                        <div class="text-sm text-green-700">CO₂ Saved</div>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-xl">
                        <div class="text-2xl font-bold text-blue-600" id="wasteCollected">0 kg</div>
                        <div class="text-sm text-blue-700">Waste Collected</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-xl">
                        <div class="text-2xl font-bold text-purple-600" id="treesEquivalent">0</div>
                        <div class="text-sm text-purple-700">Trees Equivalent</div>
                    </div>
                    <div class="text-center p-4 bg-cyan-50 rounded-xl">
                        <div class="text-2xl font-bold text-cyan-600" id="waterSaved">0 L</div>
                        <div class="text-sm text-cyan-700">Water Saved</div>
                    </div>
                </div>
                
                <!-- Impact Chart -->
                <div class="chart-container" id="impactChart">
                    <canvas id="impactChartCanvas"></canvas>
                </div>
            </div>
            
            <!-- Request Status Distribution -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-6">📊 Request Status</h3>
                
                <!-- Progress Circle -->
                <div class="flex justify-center mb-6">
                    <div class="relative w-32 h-32">
                        <svg class="w-32 h-32 progress-ring">
                            <circle cx="64" cy="64" r="40" fill="transparent" stroke="#e5e7eb" stroke-width="8"></circle>
                            <circle cx="64" cy="64" r="40" fill="transparent" stroke="#10b981" stroke-width="8" 
                                    class="progress-ring-circle" id="completionCircle"></circle>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="completionRate">0%</div>
                                <div class="text-xs text-slate-600">Completed</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Breakdown -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-slate-700">Completed</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-800" id="completedCount">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                            <span class="text-sm text-slate-700">In Progress</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-800" id="inProgressCount">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                            <span class="text-sm text-slate-700">Assigned</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-800" id="assignedCount">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-amber-500 rounded-full mr-2"></div>
                            <span class="text-sm text-slate-700">Processing</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-800" id="processingCount">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                            <span class="text-sm text-slate-700">Submitted</span>
                        </div>
                        <span class="text-sm font-semibold text-slate-800" id="submittedCount">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity Timeline -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200 mb-8">
            <h3 class="text-xl font-bold text-slate-800 mb-6">🕒 Recent Activity</h3>
            <div id="activityTimeline" class="space-y-4">
                <!-- Timeline items will be loaded here -->
                <div class="timeline-item">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-slate-800">Request Submitted</h4>
                                <p class="text-sm text-slate-600">Plastic waste cleanup request created</p>
                            </div>
                            <span class="text-xs text-slate-500">2 hours ago</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-200 mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                
                <!-- Search Bar -->
                <div class="relative flex-1 lg:max-w-md">
                    <input type="text" 
                           id="searchRequests" 
                           placeholder="Search requests by description, ID, or status..." 
                           class="search-box w-full px-4 py-3 pl-12 rounded-xl border-0 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                
                <!-- Filter Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterRequests('all')" 
                            class="filter-btn filter-active px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all duration-200 bg-slate-100 text-slate-700 hover:bg-slate-200">
                        All Requests
                    </button>
                    <button onclick="filterRequests('submitted')" 
                            class="filter-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all duration-200 bg-blue-100 text-blue-700 hover:bg-blue-200">
                        Submitted
                    </button>
                    <button onclick="filterRequests('processing')" 
                            class="filter-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all duration-200 bg-amber-100 text-amber-700 hover:bg-amber-200">
                        Processing
                    </button>
                    <button onclick="filterRequests('assigned')" 
                            class="filter-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all duration-200 bg-purple-100 text-purple-700 hover:bg-purple-200">
                        Assigned
                    </button>
                    <button onclick="filterRequests('in-progress')" 
                            class="filter-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all duration-200 bg-red-100 text-red-700 hover:bg-red-200">
                        Active
                    </button>
                    <button onclick="filterRequests('completed')" 
                            class="filter-btn px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all duration-200 bg-green-100 text-green-700 hover:bg-green-200">
                        Completed
                    </button>
                </div>
                
                <!-- Sort Options -->
                <div>
                    <select id="sortRequests" class="px-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="status">By Status</option>
                        <option value="priority">By Priority</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Add New Request Button (Desktop) -->
        <div class="hidden lg:block mb-8">
            <button onclick="window.location.href='/citizen/new-request'" 
                    class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white font-bold text-lg rounded-2xl shadow-lg shadow-emerald-600/25 hover:shadow-xl hover:shadow-emerald-600/30 transform hover:scale-105 transition-all duration-300">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                🆕 Create New Request
            </button>
        </div>

        <!-- Requests Grid -->
        <div id="requestsContainer">
            {% if requests and requests|length > 0 %}
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="requestsGrid">
                    {% for req in requests %}
                    <div class="request-card bg-white rounded-2xl shadow-lg p-6 border border-slate-200 status-{{ req.status or 'submitted' }}" 
                         data-status="{{ req.status or 'submitted' }}" 
                         data-search="{{ req.user_description | lower }} {{ req.request_id | lower }}"
                         data-created="{{ req.created_at }}">
                        
                        <!-- Request Header -->
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h4 class="font-bold text-lg text-slate-800 mb-1">
                                    {{ req.content.title or "Waste Cleanup Request" }}
                                </h4>
                                <p class="text-sm text-slate-500 font-mono">
                                    ID: {{ req.request_id or "WR-DEMO-001" }}
                                </p>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="status-badge badge-{{ req.status or 'submitted' }}">
                                    {{ req.status or 'submitted' }}
                                </span>
                                {% if req.environmental_impact %}
                                <span class="impact-badge mt-2">
                                    +{{ req.environmental_impact.environmental_score or 0 }} pts
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Request Description -->
                        <p class="text-slate-600 mb-4 line-clamp-2">
                            {{ req.user_description or "No description provided" }}
                        </p>
                        
                        <!-- Request Metadata -->
                        <div class="space-y-2 mb-4">
                            <div class="flex items-center text-sm text-slate-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Created: {{ req.created_at_display if req.created_at_display else "Unknown" }}
                            </div>
                            
                            {% if req.content and req.content.category %}
                            <div class="flex items-center text-sm text-slate-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                                </svg>
                                Category: {{ req.content.category.title() }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Environmental Impact (if completed) -->
                        {% if req.environmental_impact and req.status == 'completed' %}
                        <div class="bg-green-50 rounded-lg p-3 mb-4">
                            <h5 class="font-semibold text-green-800 text-sm mb-2">🌱 Environmental Impact</h5>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-green-600 font-medium">{{ req.environmental_impact.waste_collected_kg or 0 }} kg</span>
                                    <span class="text-green-700 block">Waste Collected</span>
                                </div>
                                <div>
                                    <span class="text-green-600 font-medium">{{ req.environmental_impact.co2_saved_kg or 0 }} kg</span>
                                    <span class="text-green-700 block">CO₂ Saved</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button onclick="viewRequestDetail('{{ req.request_id or req._id }}')" 
                                    class="flex-1 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 font-semibold py-2 px-4 rounded-xl transition-all duration-200">
                                View Details
                            </button>
                            
                            {% if req.status in ['submitted', 'processing'] %}
                            <button onclick="editRequest('{{ req.request_id or req._id }}')" 
                                    class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all duration-200">
                                Edit
                            </button>
                            {% endif %}
                            
                            {% if req.status == 'completed' %}
                            <button onclick="shareSuccess('{{ req.request_id or req._id }}')" 
                                    class="bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-xl transition-all duration-200">
                                Share
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="empty-state rounded-3xl p-12 text-center">
                    <div class="max-w-md mx-auto">
                        <svg class="w-24 h-24 text-slate-300 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h3 class="text-2xl font-bold text-slate-700 mb-4">🌱 Start Your Environmental Journey!</h3>
                        <p class="text-slate-500 mb-6 leading-relaxed">
                            You haven't created any waste cleanup requests yet. 
                            Start by reporting waste in your area and help create a cleaner, healthier environment for everyone!
                        </p>
                        <button onclick="window.location.href='/citizen/new-request'" 
                                class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white font-bold text-lg rounded-2xl shadow-lg shadow-emerald-600/25 hover:shadow-xl hover:shadow-emerald-600/30 transform hover:scale-105 transition-all duration-300">
                            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            🆕 Create Your First Request
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="hidden text-center py-12">
            <div class="max-w-md mx-auto">
                <svg class="w-24 h-24 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <h3 class="text-xl font-semibold text-slate-700 mb-2">No requests found</h3>
                <p class="text-slate-500">Try adjusting your search terms or filters</p>
            </div>
        </div>
    </div>

    <!-- Hidden data for JavaScript -->
    <script id="requests-data" type="application/json">
        {{ requests | tojson if requests else '[]' }}
    </script>

    <!-- Floating Add Button (Mobile) -->
    <button onclick="window.location.href='/citizen/new-request'" 
            class="floating-add-btn lg:hidden w-16 h-16 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-full shadow-lg shadow-emerald-600/25 hover:shadow-xl hover:shadow-emerald-600/30 flex items-center justify-center">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg>
    </button>

    <!-- Request Detail Modal -->
    <div id="requestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-slate-200 p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-slate-800">Request Details</h2>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6" id="modalContent">
                <!-- Modal content will be loaded here -->
                <div class="loading-skeleton h-64 rounded-lg"></div>
            </div>
        </div>
    </div>

    <!-- Success/Share Modal -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
            <div class="p-6 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mb-2">Share Your Impact! 🌱</h3>
                <p class="text-slate-600 mb-6">Help inspire others by sharing your environmental contribution</p>
                
                <div class="flex gap-3 justify-center">
                    <button onclick="shareToSocial('facebook')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Facebook
                    </button>
                    <button onclick="shareToSocial('twitter')" class="px-4 py-2 bg-blue-400 text-white rounded-lg hover:bg-blue-500 transition-colors">
                        Twitter
                    </button>
                    <button onclick="shareToSocial('whatsapp')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        WhatsApp
                    </button>
                    <button onclick="copyShareLink()" class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
                        Copy Link
                    </button>
                </div>
                
                <button onclick="closeShareModal()" class="mt-4 text-slate-500 hover:text-slate-700 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Include Chart.js for impact visualization
const chartScript = document.createElement('script');
chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js';
document.head.appendChild(chartScript);

// Global variables
let allRequests = [];
let currentFilter = 'all';
let currentSort = 'newest';
let impactChart = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('📋 Enhanced My Requests page loaded successfully!');
    
    // Load initial data
    loadRequestsData();
    loadStatistics();
    loadActivityTimeline();
    
    // Set up search functionality
    setupSearch();
    
    // Set up auto-refresh for active requests
    setupAutoRefresh();
    
    // Initialize charts after Chart.js loads
    setTimeout(initializeCharts, 1000);
    
    // Update last updated timestamp
    updateTimestamp();
});

// Load requests data from server
async function loadRequestsData() {
    try {
        console.log('📊 Loading requests data...');
        
        // Get requests from the page data (server-side rendered)
        // Parse from a hidden script tag that contains the JSON data
        const requestsDataElement = document.getElementById('requests-data');
        if (requestsDataElement) {
            try {
                allRequests = JSON.parse(requestsDataElement.textContent);
            } catch (parseError) {
                console.warn('⚠️ Failed to parse server requests data:', parseError);
                allRequests = [];
            }
        } else {
            // Fallback: try to fetch from API
            console.log('📡 Fetching requests from API...');
            const response = await fetch('/citizen/api/requests?limit=100');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    allRequests = data.requests || [];
                } else {
                    allRequests = [];
                }
            } else {
                allRequests = [];
            }
        }
        
        console.log(`📋 Loaded ${allRequests.length} requests`);
        updateStatistics();
        
    } catch (error) {
        console.error('❌ Error loading requests:', error);
        allRequests = []; // Fallback to empty array
        showNotification('Error loading requests', 'error');
    }
}

// Update statistics based on current data
function updateStatistics() {
    const stats = calculateStatistics(allRequests);
    
    // Update header stats
    document.getElementById('totalRequests').textContent = stats.total;
    document.getElementById('activeRequests').textContent = stats.active;
    document.getElementById('completedRequests').textContent = stats.completed;
    document.getElementById('impactScore').textContent = stats.impactScore;
    
    // Update status breakdown
    document.getElementById('completedCount').textContent = stats.completed;
    document.getElementById('inProgressCount').textContent = stats.inProgress;
    document.getElementById('assignedCount').textContent = stats.assigned;
    document.getElementById('processingCount').textContent = stats.processing;
    document.getElementById('submittedCount').textContent = stats.submitted;
    
    // Update completion rate
    const completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
    document.getElementById('completionRate').textContent = `${completionRate}%`;
    
    // Update progress circle
    updateProgressCircle(completionRate);
    
    // Update environmental impact
    document.getElementById('co2Saved').textContent = `${stats.impact.co2Saved} kg`;
    document.getElementById('wasteCollected').textContent = `${stats.impact.wasteCollected} kg`;
    document.getElementById('treesEquivalent').textContent = stats.impact.treesEquivalent;
    document.getElementById('waterSaved').textContent = `${stats.impact.waterSaved} L`;
}

// Calculate statistics from requests data
function calculateStatistics(requests) {
    const stats = {
        total: requests.length,
        submitted: 0,
        processing: 0,
        assigned: 0,
        inProgress: 0,
        completed: 0,
        rejected: 0,
        active: 0,
        impactScore: 0,
        impact: {
            co2Saved: 0,
            wasteCollected: 0,
            treesEquivalent: 0,
            waterSaved: 0
        }
    };
    
    requests.forEach(req => {
        const status = req.status || 'submitted';
        stats[status.replace('-', '')]++;
        
        if (['submitted', 'processing', 'assigned', 'in-progress'].includes(status)) {
            stats.active++;
        }
        
        // Calculate environmental impact
        if (req.environmental_impact) {
            stats.impact.co2Saved += parseFloat(req.environmental_impact.co2_saved_kg || 0);
            stats.impact.wasteCollected += parseFloat(req.environmental_impact.waste_collected_kg || 0);
            stats.impact.treesEquivalent += parseFloat(req.environmental_impact.trees_equivalent || 0);
            stats.impact.waterSaved += parseFloat(req.environmental_impact.water_saved_liters || 0);
            stats.impactScore += parseFloat(req.environmental_impact.environmental_score || 0);
        }
    });
    
    // Round impact values
    stats.impact.co2Saved = Math.round(stats.impact.co2Saved * 10) / 10;
    stats.impact.wasteCollected = Math.round(stats.impact.wasteCollected * 10) / 10;
    stats.impact.treesEquivalent = Math.round(stats.impact.treesEquivalent);
    stats.impact.waterSaved = Math.round(stats.impact.waterSaved);
    stats.impactScore = Math.round(stats.impactScore);
    
    return stats;
}

// Update progress circle animation
function updateProgressCircle(percentage) {
    const circle = document.getElementById('completionCircle');
    if (circle) {
        const circumference = 251.2; // 2 * π * r (r=40)
        const offset = circumference - (percentage / 100) * circumference;
        circle.style.strokeDashoffset = offset;
    }
}

// Initialize impact chart
function initializeCharts() {
    if (typeof Chart === 'undefined') {
        setTimeout(initializeCharts, 500);
        return;
    }
    
    const ctx = document.getElementById('impactChartCanvas');
    if (!ctx) return;
    
    // Prepare chart data
    const chartData = prepareChartData();
    
    impactChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'CO₂ Saved (kg)',
                data: chartData.co2Data,
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Waste Collected (kg)',
                data: chartData.wasteData,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });
}

// Prepare data for impact chart
function prepareChartData() {
    const timeRange = document.getElementById('impactTimeRange').value;
    
    // Get completed requests
    const completedRequests = allRequests.filter(req => 
        req.status === 'completed' && req.environmental_impact
    );
    
    // Group by time period
    const grouped = groupRequestsByTime(completedRequests, timeRange);
    
    const labels = Object.keys(grouped).sort();
    const co2Data = labels.map(label => {
        return grouped[label].reduce((sum, req) => 
            sum + parseFloat(req.environmental_impact.co2_saved_kg || 0), 0
        );
    });
    const wasteData = labels.map(label => {
        return grouped[label].reduce((sum, req) => 
            sum + parseFloat(req.environmental_impact.waste_collected_kg || 0), 0
        );
    });
    
    return { labels, co2Data, wasteData };
}

// Group requests by time period
function groupRequestsByTime(requests, timeRange) {
    const grouped = {};
    
    requests.forEach(req => {
        if (!req.completed_at) return;
        
        const date = new Date(req.completed_at);
        let key;
        
        switch (timeRange) {
            case 'week':
                key = `${date.getFullYear()}-W${getWeekNumber(date)}`;
                break;
            case 'month':
                key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                break;
            case 'year':
                key = `${date.getFullYear()}`;
                break;
            default:
                key = date.toISOString().split('T')[0];
        }
        
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(req);
    });
    
    return grouped;
}

// Get week number
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// Load activity timeline
async function loadActivityTimeline() {
    try {
        const timeline = document.getElementById('activityTimeline');
        
        // Generate timeline from recent requests
        const recentRequests = allRequests
            .slice(0, 5)
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        if (recentRequests.length === 0) {
            timeline.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-slate-400 mb-2">
                        <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="text-slate-500">No recent activity</p>
                    <p class="text-slate-400 text-sm">Your activity will appear here</p>
                </div>
            `;
            return;
        }
        
        timeline.innerHTML = recentRequests.map(req => `
            <div class="timeline-item">
                <div class="bg-slate-50 p-4 rounded-lg hover:bg-slate-100 transition-colors cursor-pointer" 
                     onclick="viewRequestDetail('${req.request_id || req._id}')">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-slate-800">${getActivityTitle(req)}</h4>
                            <p class="text-sm text-slate-600">${req.user_description || 'No description'}</p>
                            <div class="flex items-center mt-1">
                                <span class="status-badge badge-${req.status || 'submitted'}">${req.status || 'submitted'}</span>
                            </div>
                        </div>
                        <span class="text-xs text-slate-500">${formatTimeAgo(req.created_at)}</span>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('❌ Error loading timeline:', error);
    }
}

// Get activity title based on request
function getActivityTitle(req) {
    const status = req.status || 'submitted';
    const category = req.content?.category || 'waste';
    
    const titles = {
        'submitted': `${category.charAt(0).toUpperCase() + category.slice(1)} Cleanup Request Created`,
        'processing': `Request Under AI Analysis`,
        'assigned': `CleanGuard Assigned to Request`,
        'in-progress': `Cleanup in Progress`,
        'completed': `Cleanup Completed Successfully`,
        'rejected': `Request Needs Attention`
    };
    
    return titles[status] || 'Request Updated';
}

// Format time ago
function formatTimeAgo(dateString) {
    if (!dateString) return 'Unknown time';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    
    return date.toLocaleDateString();
}

// Setup search functionality
function setupSearch() {
    const searchInput = document.getElementById('searchRequests');
    const sortSelect = document.getElementById('sortRequests');
    const impactTimeRange = document.getElementById('impactTimeRange');
    
    searchInput.addEventListener('input', handleSearch);
    sortSelect.addEventListener('change', handleSort);
    impactTimeRange.addEventListener('change', updateImpactChart);
}

// Handle search input
function handleSearch() {
    const searchTerm = document.getElementById('searchRequests').value.toLowerCase();
    const filteredRequests = allRequests.filter(req => {
        const searchText = `${req.user_description || ''} ${req.request_id || ''} ${req.status || ''}`.toLowerCase();
        return searchText.includes(searchTerm);
    });
    
    displayRequests(filteredRequests);
}

// Handle sort change
function handleSort() {
    currentSort = document.getElementById('sortRequests').value;
    const visibleRequests = getFilteredRequests();
    const sortedRequests = sortRequests(visibleRequests, currentSort);
    displayRequests(sortedRequests);
}

// Sort requests
function sortRequests(requests, sortType) {
    const sorted = [...requests];
    
    switch (sortType) {
        case 'newest':
            return sorted.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        case 'oldest':
            return sorted.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        case 'status':
            const statusOrder = ['in-progress', 'assigned', 'processing', 'submitted', 'completed', 'rejected'];
            return sorted.sort((a, b) => {
                const aIndex = statusOrder.indexOf(a.status || 'submitted');
                const bIndex = statusOrder.indexOf(b.status || 'submitted');
                return aIndex - bIndex;
            });
        case 'priority':
            // Assuming priority is in content or ai_analysis
            return sorted.sort((a, b) => {
                const aPriority = a.content?.priority || a.ai_analysis?.priority || 'medium';
                const bPriority = b.content?.priority || b.ai_analysis?.priority || 'medium';
                const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                return priorityOrder[aPriority] - priorityOrder[bPriority];
            });
        default:
            return sorted;
    }
}

// Filter requests by status
function filterRequests(status) {
    currentFilter = status;
    
    // Update filter button styles
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('filter-active');
    });
    event.target.classList.add('filter-active');
    
    const filteredRequests = getFilteredRequests();
    const sortedRequests = sortRequests(filteredRequests, currentSort);
    displayRequests(sortedRequests);
}

// Get filtered requests
function getFilteredRequests() {
    if (currentFilter === 'all') {
        return allRequests;
    }
    
    return allRequests.filter(req => (req.status || 'submitted') === currentFilter);
}

// Display requests in grid
function displayRequests(requests) {
    const container = document.getElementById('requestsGrid');
    const noResults = document.getElementById('noResults');
    
    if (!container) return;
    
    if (requests.length === 0) {
        container.style.display = 'none';
        noResults.classList.remove('hidden');
        return;
    }
    
    container.style.display = 'grid';
    noResults.classList.add('hidden');
    
    // Update the grid with filtered requests
    // Since we're using server-side rendering, we'll hide/show existing cards
    const allCards = document.querySelectorAll('.request-card');
    
    allCards.forEach(card => {
        const cardStatus = card.dataset.status;
        const cardSearch = card.dataset.search;
        const searchTerm = document.getElementById('searchRequests').value.toLowerCase();
        
        const matchesFilter = currentFilter === 'all' || cardStatus === currentFilter;
        const matchesSearch = !searchTerm || cardSearch.includes(searchTerm);
        
        if (matchesFilter && matchesSearch) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// View request details
async function viewRequestDetail(requestId) {
    try {
        console.log(`📄 Viewing details for request: ${requestId}`);
        
        const modal = document.getElementById('requestModal');
        const modalContent = document.getElementById('modalContent');
        
        // Show modal with loading
        modal.classList.remove('hidden');
        modalContent.innerHTML = '<div class="loading-skeleton h-64 rounded-lg"></div>';
        
        // Find request in current data
        const request = allRequests.find(req => 
            req.request_id === requestId || req._id === requestId
        );
        
        if (!request) {
            modalContent.innerHTML = `
                <div class="text-center py-8">
                    <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                    </svg>
                    <h3 class="text-lg font-semibold text-slate-700 mb-2">Request not found</h3>
                    <p class="text-slate-500">The requested details could not be loaded.</p>
                </div>
            `;
            return;
        }
        
        // Render request details
        modalContent.innerHTML = renderRequestDetails(request);
        
    } catch (error) {
        console.error('❌ Error viewing request details:', error);
        showNotification('Error loading request details', 'error');
    }
}

// Render request details modal content
function renderRequestDetails(request) {
    const status = request.status || 'submitted';
    const impact = request.environmental_impact || {};
    
    return `
        <div class="space-y-6">
            <!-- Request Header -->
            <div class="border-b border-slate-200 pb-4">
                <div class="flex items-start justify-between mb-2">
                    <h3 class="text-xl font-bold text-slate-800">
                        ${request.content?.title || 'Waste Cleanup Request'}
                    </h3>
                    <span class="status-badge badge-${status}">${status}</span>
                </div>
                <p class="text-slate-600 font-mono text-sm">ID: ${request.request_id || request._id}</p>
                <p class="text-slate-500 text-sm">
                    Created: ${request.created_at ? new Date(request.created_at).toLocaleString() : 'Unknown'}
                </p>
            </div>
            
            <!-- Description -->
            <div>
                <h4 class="font-semibold text-slate-800 mb-2">Description</h4>
                <p class="text-slate-600 bg-slate-50 p-3 rounded-lg">
                    ${request.user_description || 'No description provided'}
                </p>
            </div>
            
            <!-- Location -->
            ${request.location ? `
            <div>
                <h4 class="font-semibold text-slate-800 mb-2">📍 Location</h4>
                <div class="bg-slate-50 p-3 rounded-lg">
                    <p class="text-slate-600">${request.location.address || 'Address not provided'}</p>
                    ${request.location.latitude && request.location.longitude ? `
                    <p class="text-slate-500 text-sm mt-1">
                        Coordinates: ${request.location.latitude}, ${request.location.longitude}
                    </p>
                    ` : ''}
                </div>
            </div>
            ` : ''}
            
            <!-- AI Analysis -->
            ${request.ai_analysis ? `
            <div>
                <h4 class="font-semibold text-slate-800 mb-2">🤖 AI Analysis</h4>
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="font-medium text-blue-800">Waste Type:</span>
                            <span class="text-blue-700">${request.ai_analysis.waste_type || 'Unknown'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-800">Confidence:</span>
                            <span class="text-blue-700">${Math.round((request.ai_analysis.confidence || 0) * 100)}%</span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-800">Quantity:</span>
                            <span class="text-blue-700">${request.ai_analysis.quantity_estimate || 'Unknown'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-blue-800">Priority:</span>
                            <span class="text-blue-700">${request.ai_analysis.priority || 'Medium'}</span>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- Worker Assignment -->
            ${request.assigned_worker ? `
            <div>
                <h4 class="font-semibold text-slate-800 mb-2">👷 Assigned CleanGuard</h4>
                <div class="bg-purple-50 p-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium text-purple-800">${request.assigned_worker.name}</p>
                            <p class="text-purple-600 text-sm">${request.assigned_worker.category || 'CleanGuard'}</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center text-purple-600">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span class="text-sm">${request.assigned_worker.rating || '4.5'}</span>
                            </div>
                            <p class="text-purple-600 text-xs">${request.assigned_worker.distance || 'Unknown distance'}</p>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- Environmental Impact -->
            ${status === 'completed' && Object.keys(impact).length > 0 ? `
            <div>
                <h4 class="font-semibold text-slate-800 mb-2">🌱 Environmental Impact</h4>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${impact.waste_collected_kg || 0} kg</div>
                            <div class="text-green-700 text-sm">Waste Collected</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${impact.co2_saved_kg || 0} kg</div>
                            <div class="text-green-700 text-sm">CO₂ Saved</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${impact.trees_equivalent || 0}</div>
                            <div class="text-green-700 text-sm">Trees Equivalent</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">${impact.water_saved_liters || 0} L</div>
                            <div class="text-green-700 text-sm">Water Saved</div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                            Environmental Score: ${impact.environmental_score || 0} points
                        </span>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- Images -->
            ${request.cloudinary_urls && request.cloudinary_urls.length > 0 ? `
            <div>
                <h4 class="font-semibold text-slate-800 mb-2">📸 Images</h4>
                <div class="grid grid-cols-2 gap-2">
                    ${request.cloudinary_urls.map(url => `
                        <img src="${url}" alt="Request image" class="w-full h-32 object-cover rounded-lg border border-slate-200 hover:border-slate-300 transition-colors cursor-pointer" 
                             onclick="openImageModal('${url}')">
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- Status Timeline -->
            <div>
                <h4 class="font-semibold text-slate-800 mb-2">📋 Status Timeline</h4>
                <div class="space-y-2">
                    ${generateStatusTimeline(request)}
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4 border-t border-slate-200">
                ${status === 'completed' ? `
                    <button onclick="shareSuccess('${request.request_id || request._id}')" 
                            class="flex-1 bg-green-50 hover:bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-xl transition-all duration-200">
                        🎉 Share Success
                    </button>
                ` : ''}
                
                ${['submitted', 'processing'].includes(status) ? `
                    <button onclick="editRequest('${request.request_id || request._id}')" 
                            class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-xl transition-all duration-200">
                        ✏️ Edit Request
                    </button>
                ` : ''}
                
                <button onclick="trackRequest('${request.request_id || request._id}')" 
                        class="flex-1 bg-purple-50 hover:bg-purple-100 text-purple-700 font-semibold py-2 px-4 rounded-xl transition-all duration-200">
                    📍 Track Progress
                </button>
                
                <button onclick="contactSupport('${request.request_id || request._id}')" 
                        class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-xl transition-all duration-200">
                    💬 Contact Support
                </button>
            </div>
        </div>
    `;
}

// Generate status timeline
function generateStatusTimeline(request) {
    const status = request.status || 'submitted';
    const createdDate = request.created_at ? new Date(request.created_at).toLocaleString() : 'Unknown';
    
    const statuses = [
        { key: 'submitted', label: 'Request Submitted', icon: '📝', completed: true },
        { key: 'processing', label: 'AI Analysis', icon: '🤖', completed: ['processing', 'assigned', 'in-progress', 'completed'].includes(status) },
        { key: 'assigned', label: 'CleanGuard Assigned', icon: '👷', completed: ['assigned', 'in-progress', 'completed'].includes(status) },
        { key: 'in-progress', label: 'Cleanup in Progress', icon: '🧹', completed: ['in-progress', 'completed'].includes(status) },
        { key: 'completed', label: 'Cleanup Completed', icon: '✅', completed: status === 'completed' }
    ];
    
    return statuses.map(statusItem => `
        <div class="flex items-center ${statusItem.completed ? 'text-green-600' : 'text-slate-400'}">
            <span class="text-lg mr-2">${statusItem.icon}</span>
            <span class="font-medium">${statusItem.label}</span>
            ${statusItem.completed ? 
                `<svg class="w-4 h-4 ml-auto text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                </svg>` : 
                `<svg class="w-4 h-4 ml-auto text-slate-300" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"/>
                </svg>`
            }
        </div>
    `).join('');
}

// Close modal
function closeModal() {
    document.getElementById('requestModal').classList.add('hidden');
}

// Edit request
function editRequest(requestId) {
    console.log(`✏️ Editing request: ${requestId}`);
    window.location.href = `/citizen/edit-request/${requestId}`;
}

// Track request
function trackRequest(requestId) {
    console.log(`📍 Tracking request: ${requestId}`);
    window.location.href = `/citizen/track/${requestId}`;
}

// Contact support
function contactSupport(requestId) {
    console.log(`💬 Contacting support for request: ${requestId}`);
    showNotification('Opening support chat...', 'info');
    // Here you would open a support chat or modal
}

// Share success functionality
function shareSuccess(requestId) {
    const modal = document.getElementById('shareModal');
    modal.classList.remove('hidden');
    
    // Store current request ID for sharing
    window.currentShareRequestId = requestId;
}

// Close share modal
function closeShareModal() {
    document.getElementById('shareModal').classList.add('hidden');
    window.currentShareRequestId = null;
}

// Share to social media
function shareToSocial(platform) {
    const requestId = window.currentShareRequestId;
    if (!requestId) return;
    
    const request = allRequests.find(req => 
        req.request_id === requestId || req._id === requestId
    );
    
    if (!request || !request.environmental_impact) return;
    
    const impact = request.environmental_impact;
    const message = `🌱 I just helped clean up ${impact.waste_collected_kg || 0}kg of waste and saved ${impact.co2_saved_kg || 0}kg of CO₂! Join me on Meri Dharani to make our environment cleaner! #MeriDharani #CleanIndia #EnvironmentalImpact`;
    
    const urls = {
        facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(message)}`,
        twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(window.location.href)}`,
        whatsapp: `https://wa.me/?text=${encodeURIComponent(message + ' ' + window.location.href)}`
    };
    
    if (urls[platform]) {
        window.open(urls[platform], '_blank', 'width=600,height=400');
    }
    
    closeShareModal();
    showNotification('Shared successfully!', 'success');
}

// Copy share link
function copyShareLink() {
    const link = window.location.href;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
            showNotification('Link copied to clipboard!', 'success');
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = link;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Link copied to clipboard!', 'success');
    }
    
    closeShareModal();
}

// Update impact chart when time range changes
function updateImpactChart() {
    if (impactChart) {
        const chartData = prepareChartData();
        impactChart.data.labels = chartData.labels;
        impactChart.data.datasets[0].data = chartData.co2Data;
        impactChart.data.datasets[1].data = chartData.wasteData;
        impactChart.update();
    }
}

// Setup auto-refresh for active requests
function setupAutoRefresh() {
    setInterval(async function() {
        // Only refresh if there are active requests
        const activeRequests = allRequests.filter(req => 
            ['submitted', 'processing', 'assigned', 'in-progress'].includes(req.status || 'submitted')
        );
        
        if (activeRequests.length > 0) {
            console.log('🔄 Auto-refreshing active requests...');
            await refreshRequestsData();
        }
    }, 30000); // Refresh every 30 seconds
}

// Refresh requests data from server
async function refreshRequestsData() {
    try {
        const response = await fetch('/citizen/api/requests');
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.reports) {
                allRequests = data.reports;
                updateStatistics();
                loadActivityTimeline();
                updateTimestamp();
                
                // Re-apply current filters
                const filteredRequests = getFilteredRequests();
                const sortedRequests = sortRequests(filteredRequests, currentSort);
                displayRequests(sortedRequests);
            }
        }
    } catch (error) {
        console.error('❌ Error refreshing requests:', error);
    }
}

// Update timestamp
function updateTimestamp() {
    const timestampElement = document.getElementById('lastUpdated');
    if (timestampElement) {
        timestampElement.textContent = new Date().toLocaleTimeString();
    }
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
    
    const colors = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        info: 'bg-blue-500 text-white',
        warning: 'bg-yellow-500 text-black'
    };
    
    notification.className += ` ${colors[type] || colors.info}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Open image modal (if needed)
function openImageModal(imageUrl) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${imageUrl}" alt="Request image" class="max-w-full max-h-full object-contain rounded-lg">
            <button onclick="this.closest('.fixed').remove()" 
                    class="absolute top-4 right-4 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-full p-2 transition-all">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on background click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Close modal on outside click
document.getElementById('requestModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Close share modal on outside click
document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeShareModal();
    }
});

// Add smooth animations on load
document.addEventListener('DOMContentLoaded', function() {
    // Animate request cards on load
    const cards = document.querySelectorAll('.request-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Animate stats cards
    const statsCards = document.querySelectorAll('.metric-card');
    statsCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 500 + (index * 100));
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Escape key to close modals
    if (e.key === 'Escape') {
        closeModal();
        closeShareModal();
    }
    
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('searchRequests').focus();
    }
    
    // Ctrl/Cmd + N to create new request
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        window.location.href = '/citizen/new-request';
    }
});

// Load statistics from server (enhanced version)
async function loadStatistics() {
    try {
        console.log('📊 Loading statistics from API...');
        
        // Try to fetch live statistics from server
        const response = await fetch('/citizen/api/statistics');
        console.log('📊 Statistics response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('📊 Statistics API response:', data);
            
            if (data.success && data.statistics) {
                console.log('✅ Updating UI with server statistics');
                updateStatisticsFromServer(data.statistics);
                return;
            } else {
                console.warn('⚠️ API response was not successful:', data);
            }
        } else {
            console.error('❌ Statistics API returned error:', response.status);
        }
        
        // Fallback to client-side calculation
        console.log('🔄 Falling back to client-side calculation');
        updateStatistics();
        
    } catch (error) {
        console.error('❌ Error loading statistics:', error);
        updateStatistics(); // Fallback to client-side calculation
    }
}

// Update statistics from server data
function updateStatisticsFromServer(stats) {
    console.log('🔧 Updating UI with stats:', stats);
    
    try {
        // 🔥 Update header stats with CORRECT field names
        const totalEl = document.getElementById('totalRequests');
        const activeEl = document.getElementById('activeRequests');  
        const completedEl = document.getElementById('completedRequests');
        const impactEl = document.getElementById('impactScore');
        
        if (totalEl) {
            totalEl.textContent = stats.total || 0;
            console.log('✅ Updated totalRequests:', stats.total);
        }
        if (activeEl) {
            activeEl.textContent = stats.active || 0;
            console.log('✅ Updated activeRequests:', stats.active);
        }
        if (completedEl) {
            completedEl.textContent = stats.completed || 0;
            console.log('✅ Updated completedRequests:', stats.completed);
        }
        if (impactEl) {
            impactEl.textContent = stats.impactScore || 0;
            console.log('✅ Updated impactScore:', stats.impactScore);
        }
        
        // 🔥 Update status breakdown with EXACT element IDs
        const completedCountEl = document.getElementById('completedCount');
        const inProgressCountEl = document.getElementById('inProgressCount');
        const assignedCountEl = document.getElementById('assignedCount');
        const processingCountEl = document.getElementById('processingCount');
        const submittedCountEl = document.getElementById('submittedCount');
        
        if (completedCountEl) {
            completedCountEl.textContent = stats.completed || 0;
            console.log('✅ Updated completedCount:', stats.completed);
        }
        if (inProgressCountEl) {
            inProgressCountEl.textContent = stats.inProgress || 0;
            console.log('✅ Updated inProgressCount:', stats.inProgress);
        }
        if (assignedCountEl) {
            assignedCountEl.textContent = stats.assigned || 0;
            console.log('✅ Updated assignedCount:', stats.assigned);
        }
        if (processingCountEl) {
            processingCountEl.textContent = stats.processing || 0;
            console.log('✅ Updated processingCount:', stats.processing);
        }
        if (submittedCountEl) {
            submittedCountEl.textContent = stats.submitted || 0;
            console.log('✅ Updated submittedCount:', stats.submitted);
        }
        
        // Update environmental impact
        const co2El = document.getElementById('co2Saved');
        const wasteEl = document.getElementById('wasteCollected');
        const treesEl = document.getElementById('treesEquivalent');
        const waterEl = document.getElementById('waterSaved');
        
        if (co2El && stats.impact) {
            co2El.textContent = `${stats.impact.co2Saved || 0} kg`;
            console.log('✅ Updated co2Saved:', stats.impact.co2Saved);
        }
        if (wasteEl && stats.impact) {
            wasteEl.textContent = `${stats.impact.wasteCollected || 0} kg`;
            console.log('✅ Updated wasteCollected:', stats.impact.wasteCollected);
        }
        if (treesEl && stats.impact) {
            treesEl.textContent = stats.impact.treesEquivalent || 0;
            console.log('✅ Updated treesEquivalent:', stats.impact.treesEquivalent);
        }
        if (waterEl && stats.impact) {
            waterEl.textContent = `${stats.impact.waterSaved || 0} L`;
            console.log('✅ Updated waterSaved:', stats.impact.waterSaved);
        }
        
        // Update completion rate
        const completionRate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
        const completionRateEl = document.getElementById('completionRate');
        if (completionRateEl) {
            completionRateEl.textContent = `${completionRate}%`;
            console.log('✅ Updated completionRate:', completionRate);
        }
        
        updateProgressCircle(completionRate);
        
        console.log('✅ UI updated successfully with server statistics');
        
    } catch (error) {
        console.error('❌ Error updating UI with server statistics:', error);
    }
}

console.log('🎯 Enhanced My Requests JavaScript loaded successfully!');
</script>
{% endblock %}